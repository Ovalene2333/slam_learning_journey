# 5.如何驯服斜放的雷达

这是一个在机器人和自动驾驶领域中常见且重要的问题。当激光雷达(LiDAR)相对于惯性测量单元(IMU)或车体坐标系存在倾斜安装时，如果不能正确地配置其外参，将会严重影响SLAM算法的建图和定位精度。

## 从雷达的外参说起

在大多数SLAM框架（如`FAST-LIO`）的配置文件中，我们都能找到用于描述LiDAR和IMU之间相对位姿的参数。这通常被称为外参（Extrinsics）。

以`FAST-LIO`为例，其配置文件`config/mid360.yaml`中包含以下参数：
```yaml
# LiDAR到IMU的外参
extrinsic_T: [ -0.011, -0.02329, 0.04412 ]
extrinsic_R: [ 1., 0., 0.,
         0., 1., 0.,
         0., 0., 1.]
```

这里的参数定义了从**LiDAR坐标系**到**IMU坐标系**的变换关系，即 $T_{imu\_lidar}$。

-   `extrinsic_T`: 表示从LiDAR坐标系原点到IMU坐标系原点的**平移向量**，单位为米。
-   `extrinsic_R`: 表示从LiDAR坐标系到IMU坐标系的**旋转矩阵**。它是一个3x3的矩阵，在YAML文件中通常以行主序的9个元素数组表示。

### 理解旋转矩阵 `extrinsic_R`

在上述示例配置中，`extrinsic_R`是一个单位矩阵。这表示**LiDAR坐标系与IMU坐标系的姿态是完全对齐的**，即X轴、Y轴、Z轴分别平行。

然而，当雷达被**倾斜**或**旋转**安装时，这个矩阵就不再是单位矩阵了。例如，如果LiDAR绕其自身的Y轴向前倾斜了15度，那么从LiDAR到IMU的旋转关系就需要相应地更新。

### 这个参数的作用

这个参数告诉了里程计要如何处理lidar和imu的数据。而在默认情况下，这个参数是**不需要进行修改的**!试想一下，你拿着雷达在空间中晃动，但是里程计却在正常的运行和定位，这个期间$T_{imu\_lidar}$其实并没有发生变化!而如果这个参数被错误地设置,你的里程计很有可能会飞出宇宙之外。

> TODO: 你可以尝试调整`livox_ros_driver2/config/MID360_config.json`中的`lidar_configs.extrinsic_parameter.pitch(yaw)`,比如调整这个参数让你的点云看起来是与地面平行的。然后在默认参数下启动你的里程计,转一下yaw,然后你就会发现里程计像醉了酒一样来回摇摆甚至直接没救的飞出去,~~飞(里程)计悲~~。这个时候你相当于调整了lidar和imu的外参,但是里程计里面的参数`extrinsic_T`和`extrinsic_R`却没有调整,于是不出意外的出意外了。

所以,即使你的雷达是倾斜安装的,不修改这个参数,你的里程计定位也不会出现问题,只是里程计的表达换了一个参考坐标系——如果你的雷达是水平放置的,你的里程计就是基于一个初始水平的坐标系表达的;如果你的雷达是倾斜放置的,你的里程计就是基于一个初始倾斜的坐标系表达的。

这显然会导致很多问题。比如以`FAST-LIO`为例,如果你的雷达倾斜30°放置,里程计表达的默认的坐标变换为`camera_init`->`body`,那么这两个坐标系也都是倾斜30°的,而最后建出来的图也是倾斜30°的,发布的点云倾斜30°的,这显然很不方便!

而为了解决这一问题,我们有几种方法。

### 方法一:调整点云的角度并调整外参(标定)

这个方法需要同时调整`livox_ros_driver2/config/MID360_config.json`中的`lidar_configs.extrinsic_parameter.pitch`,并调整里程计里面的参数`extrinsic_T`和`extrinsic_R`。

一般来说对于这种流程,我们有个更常见的名字,叫**标定**

#### 推荐工具：`LiDAR_IMU_Init`

对于LiDAR和IMU外参的自动标定，推荐使用香港大学MARS实验室开源的工具包 [**LiDAR_IMU_Init**](https://github.com/hku-mars/LiDAR_IMU_Init)。

**使用说明：**

*   **ROS 1 环境：**
  该工具是一个标准的ROS 1功能包，可以直接在ROS 1系统上编译和运行。

*   **ROS 2 环境：**
  如果您在ROS 2环境下工作，可以遵循以下流程：
  1.  使用 `ros2 bag record` 录制数据包。**注意**：请确保点云话题的格式为 `sensor_msgs/PointCloud2`,而不是`livox_ros_driver2/CustomMsg`.
  2.  将录制好的 `rosbag2` 文件转换为ROS 1兼容的 `.bag` 格式。
  3.  在ROS 1环境中使用转换后的数据包运行标定程序。

*   **Docker 环境：**
  官方也提供了Docker镜像，可以帮助用户快速搭建运行环境，避免繁琐的依赖配置。(我没测试过)

### 方法二:基于初始IMU数据作gravity_align(更推荐)